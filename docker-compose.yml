services:
  # PostgreSQL Database
  postgres:
    image: postgres:14-alpine
    container_name: bank-postgres
    environment:
      POSTGRES_DB: bankdb
      POSTGRES_USER: bank_user
      POSTGRES_PASSWORD: bank_password
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - bank-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bank_user -d bankdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Eureka Service Discovery
  eureka-server:
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    container_name: bank-eureka
    ports:
      - "8761:8761"
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Config Server
  config-server:
    build:
      context: ./config-server
      dockerfile: Dockerfile
    container_name: bank-config
    ports:
      - "8888:8888"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_PROFILES_ACTIVE: native
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: file:/config
    volumes:
      - ./config-server/src/main/resources/config:/config
    networks:
      - bank-network
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8888/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Gateway Service
  gateway-service:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    ports:
      - "8080:8080"
    depends_on:
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Auth Server
  auth-server:
    build:
      context: ./auth-server
      dockerfile: Dockerfile
    container_name: bank-auth
    ports:
      - "9100:9100"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bankdb
      SPRING_DATASOURCE_USERNAME: bank_user
      SPRING_DATASOURCE_PASSWORD: bank_password
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9100/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Accounts Service
  accounts-service:
    build:
      context: ./accounts-service
      dockerfile: Dockerfile
    container_name: bank-accounts
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bankdb
      SPRING_DATASOURCE_USERNAME: bank_user
      SPRING_DATASOURCE_PASSWORD: bank_password
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Cash Service
  cash-service:
    build:
      context: ./cash-service
      dockerfile: Dockerfile
    container_name: bank-cash
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bankdb
      SPRING_DATASOURCE_USERNAME: bank_user
      SPRING_DATASOURCE_PASSWORD: bank_password
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Transfer Service
  transfer-service:
    build:
      context: ./transfer-service
      dockerfile: Dockerfile
    container_name: bank-transfer
    ports:
      - "8083:8083"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bankdb
      SPRING_DATASOURCE_USERNAME: bank_user
      SPRING_DATASOURCE_PASSWORD: bank_password
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Exchange Service
  exchange-service:
    build:
      context: ./exchange-service
      dockerfile: Dockerfile
    container_name: bank-exchange
    ports:
      - "8084:8084"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bankdb
      SPRING_DATASOURCE_USERNAME: bank_user
      SPRING_DATASOURCE_PASSWORD: bank_password
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Exchange Generator Service
  exchange-generator-service:
    build:
      context: ./exchange-generator-service
      dockerfile: Dockerfile
    container_name: bank-exchange-generator
    ports:
      - "8085:8085"
    depends_on:
      eureka-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
      exchange-service:
        condition: service_healthy
    environment:
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Blocker Service
  blocker-service:
    build:
      context: ./blocker-service
      dockerfile: Dockerfile
    container_name: bank-blocker
    ports:
      - "8086:8086"
    depends_on:
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
    environment:
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Notifications Service
  notifications-service:
    build:
      context: ./notifications-service
      dockerfile: Dockerfile
    container_name: bank-notifications
    ports:
      - "8087:8087"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-server:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bankdb
      SPRING_DATASOURCE_USERNAME: bank_user
      SPRING_DATASOURCE_PASSWORD: bank_password
      CONFIG_SERVER_URL: http://config-server:8888
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://auth-server:9100
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_BANK_CLIENT_TOKEN_URI: http://auth-server:9100/oauth2/token
      SPRING_PROFILES_ACTIVE: docker
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Frontend UI
  front-ui:
    build:
      context: ./front-ui
      dockerfile: Dockerfile
    container_name: bank-frontend
    ports:
      - "8090:8090"
    depends_on:
      eureka-server:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
      auth-server:
        condition: service_healthy
      accounts-service:
        condition: service_healthy
      transfer-service:
        condition: service_healthy
      cash-service:
        condition: service_healthy
      exchange-service:
        condition: service_healthy
      exchange-generator-service:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      AUTH_SERVER_URL: http://auth-server:9100
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

networks:
  bank-network:
    driver: bridge

volumes:
  postgres-data:
