apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "bank-app-grafana.fullname" . }}-test-connection"
  labels:
    {{- include "bank-app-grafana.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  containers:
    - name: test-grafana
      image: curlimages/curl:8.1.2
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing Grafana connection..."

          # Wait for Grafana to be ready (health endpoint available)
          MAX_RETRIES=60
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf http://{{ include "bank-app-grafana.fullname" . }}:3000/api/health > /dev/null 2>&1; then
              echo "✓ Grafana is accessible"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Grafana... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 3
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "✗ Failed to connect to Grafana after $MAX_RETRIES attempts"
            exit 1
          fi

          # Check Grafana health JSON
          echo "Checking Grafana health..."
          HEALTH=$(curl -s http://{{ include "bank-app-grafana.fullname" . }}:3000/api/health)
          echo "Grafana health response: $HEALTH"

          if echo "$HEALTH" | grep -Eq '"database"[[:space:]]*:[[:space:]]*"ok"'; then
            echo "✓ Grafana database is healthy"
          else
            echo "⚠ Grafana database status not 'ok'"
          fi

          # Attempt authenticated org API (may require admin credentials)
          # Handle auto-generated password case
          ADMIN_USER="{{ .Values.grafana.adminUser }}"
          {{- if .Values.grafana.adminPassword }}
          ADMIN_PASS="{{ .Values.grafana.adminPassword }}"
          {{- else }}
          # Password is auto-generated, skip authenticated tests
          ADMIN_PASS=""
          echo "ℹ Note: Grafana password is auto-generated. Skipping authenticated API tests."
          echo "ℹ To retrieve password: kubectl get secret {{ include "bank-app-grafana.fullname" . }} -n {{ .Release.Namespace }} -o jsonpath='{.data.admin-password}' | base64 -d"
          {{- end }}

          {{- if .Values.grafana.adminPassword }}
          echo "Testing Grafana /api/org (authenticated)..."
          ORG_RESPONSE_CODE=$(curl -u "$ADMIN_USER:$ADMIN_PASS" -s -o /dev/null -w '%{http_code}' http://{{ include "bank-app-grafana.fullname" . }}:3000/api/org || true)
          if [ "$ORG_RESPONSE_CODE" = "200" ]; then
            echo "✓ Authenticated org API responded (200)"
          else
            echo "⚠ Org API returned HTTP $ORG_RESPONSE_CODE (continuing)"
          fi

          # Check Prometheus datasource provisioning
          echo "Checking Prometheus datasource provisioning..."
          DS_RETRIES=0
          DS_MAX=10
          DS_FOUND=false
          while [ $DS_RETRIES -lt $DS_MAX ]; do
            DATASOURCES=$(curl -s -u "$ADMIN_USER:$ADMIN_PASS" http://{{ include "bank-app-grafana.fullname" . }}:3000/api/datasources || true)
            if echo "$DATASOURCES" | grep -q '"name"[[:space:]]*:[[:space:]]*"Prometheus"'; then
              DS_FOUND=true
              echo "✓ Prometheus datasource is configured"
              break
            fi
            DS_RETRIES=$((DS_RETRIES + 1))
            echo "Waiting for Prometheus datasource... ($DS_RETRIES/$DS_MAX)"
            sleep 3
          done
          if [ "$DS_FOUND" != true ]; then
            echo "⚠ Prometheus datasource not detected after retries (may still be provisioning)"
          fi
          {{- end }}

          # Test a public search endpoint (should generally work even w/o auth if anonymous enabled)
          echo "Testing Grafana search API..."
          SEARCH_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://{{ include "bank-app-grafana.fullname" . }}:3000/api/search?query= || true)
          if [ "$SEARCH_CODE" = "200" ]; then
            echo "✓ Grafana search API responded (200)"
          else
            echo "⚠ Grafana search API returned HTTP $SEARCH_CODE"
          fi

          echo "✓ Grafana test routine completed"
  restartPolicy: Never
