apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "bank-app-zipkin.fullname" . }}-test-connection"
  labels:
    {{- include "bank-app-zipkin.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  containers:
    - name: test-zipkin
      image: curlimages/curl:8.1.2
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing Zipkin connection..."

          # Wait for Zipkin to be ready
          MAX_RETRIES=60
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf http://{{ include "bank-app-zipkin.fullname" . }}:9411/health > /dev/null 2>&1; then
              echo "✓ Zipkin is accessible"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Zipkin... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 3
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "✗ Failed to connect to Zipkin after $MAX_RETRIES attempts"
            exit 1
          fi

          # Check Zipkin health
          echo "Checking Zipkin health..."
          HEALTH=$(curl -s http://{{ include "bank-app-zipkin.fullname" . }}:9411/health)
          echo "Zipkin health response: $HEALTH"

          if echo "$HEALTH" | grep -q '"status"[[:space:]]*:[[:space:]]*"UP"'; then
            echo "✓ Zipkin is healthy and UP"
          else
            echo "✗ Zipkin health check failed"
            exit 1
          fi

          # Test Zipkin API endpoint
          echo "Testing Zipkin API..."
          if curl -sf http://{{ include "bank-app-zipkin.fullname" . }}:9411/api/v2/services > /dev/null 2>&1; then
            echo "✓ Zipkin API is responding"
          else
            echo "✗ Zipkin API is not responding"
            exit 1
          fi

          echo "✓ All Zipkin tests passed!"
  restartPolicy: Never