apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-connection"
  labels:
    {{- include "logstash.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: test-logstash
      image: curlimages/curl:8.1.2
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing Logstash connection..."

          # Wait for Logstash to be ready
          MAX_RETRIES=30
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf http://{{ .Release.Name }}-logstash-headless:9600; then
              echo "✓ Logstash is accessible"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Logstash... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 2
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "✗ Failed to connect to Logstash after $MAX_RETRIES attempts"
            exit 1
          fi

          # Check Logstash health
          echo "Checking Logstash health..."
          RESPONSE=$(curl -s http://{{ .Release.Name }}-logstash-headless:9600)
          echo "$RESPONSE"

          # Verify Logstash is responding
          if echo "$RESPONSE" | grep -q "version"; then
            echo "✓ Logstash is responding correctly"
          else
            echo "⚠ Unexpected response from Logstash"
          fi

          echo "✓ All Logstash tests passed!"
  restartPolicy: Never
