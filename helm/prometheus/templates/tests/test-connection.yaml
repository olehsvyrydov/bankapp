apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "bank-app-prometheus.fullname" . }}-test-connection"
  labels:
    {{- include "bank-app-prometheus.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  containers:
    - name: test-prometheus
      image: curlimages/curl:8.1.2
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing Prometheus connection..."

          # Wait for Prometheus server to be ready
          MAX_RETRIES=60
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf http://{{ include "bank-app-prometheus.fullname" . }}-server:9090/-/healthy > /dev/null 2>&1; then
              echo "✓ Prometheus server is accessible"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Prometheus server... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 3
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "✗ Failed to connect to Prometheus after $MAX_RETRIES attempts"
            exit 1
          fi

          # Check Prometheus health
          echo "Checking Prometheus health..."
          if curl -sf http://{{ include "bank-app-prometheus.fullname" . }}-server:9090/-/healthy > /dev/null 2>&1; then
            echo "✓ Prometheus server is healthy"
          else
            echo "✗ Prometheus health check failed"
            exit 1
          fi

          # Check Prometheus readiness
          echo "Checking Prometheus readiness..."
          if curl -sf http://{{ include "bank-app-prometheus.fullname" . }}-server:9090/-/ready > /dev/null 2>&1; then
            echo "✓ Prometheus server is ready"
          else
            echo "✗ Prometheus readiness check failed"
            exit 1
          fi

          # Test Prometheus API
          echo "Testing Prometheus API..."
          if curl -sf http://{{ include "bank-app-prometheus.fullname" . }}-server:9090/api/v1/query?query=up > /dev/null 2>&1; then
            echo "✓ Prometheus API is responding"
          else
            echo "✗ Prometheus API is not responding"
            exit 1
          fi

          echo "✓ All Prometheus tests passed!"
  restartPolicy: Never
