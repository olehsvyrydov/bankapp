apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "bank-app.fullname" . }}-test-configs"
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "bank-app.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "bank-app.fullname" . }}-test
  containers:
    - name: kubectl-test
      image: bitnami/kubectl:latest
      command: ['sh', '-c']
      args:
        - |
          echo "Testing ConfigMaps and Secrets existence..."

          # Test ConfigMaps
          echo "Checking ConfigMaps..."
          CONFIGMAPS="postgresql-init auth-server accounts-service transfer-service cash-service exchange-service exchange-generator-service notifications-service blocker-service gateway-service front-ui"

          for cm in $CONFIGMAPS; do
            echo "Checking ConfigMap: {{ .Release.Name }}-$cm"
            kubectl get configmap {{ .Release.Name }}-$cm -n {{ .Values.global.namespace }} || exit 1
            echo "ConfigMap $cm exists ✓"
          done

          # Test Secrets
          echo ""
          echo "Checking Secrets..."
          SECRETS="postgresql auth-server accounts-service transfer-service cash-service exchange-service exchange-generator-service notifications-service blocker-service gateway-service"

          for secret in $SECRETS; do
            echo "Checking Secret: {{ .Release.Name }}-$secret"
            kubectl get secret {{ .Release.Name }}-$secret -n {{ .Values.global.namespace }} || exit 1
            echo "Secret $secret exists ✓"
          done

          # Test Services
          echo ""
          echo "Checking Services..."
          SERVICES="postgresql auth-server accounts-service transfer-service cash-service exchange-service exchange-generator-service notifications-service blocker-service gateway-service front-ui"

          for svc in $SERVICES; do
            echo "Checking Service: {{ .Release.Name }}-$svc"
            kubectl get service {{ .Release.Name }}-$svc -n {{ .Values.global.namespace }} || exit 1
            echo "Service $svc exists ✓"
          done

          {{- if .Values.kafka.enabled }}
          # Check Kafka service
          echo "Checking Kafka Service: {{ .Release.Name }}-kafka"
          kubectl get service {{ .Release.Name }}-kafka -n {{ .Values.global.namespace }} || exit 1
          echo "Kafka service exists ✓"

          # Check Kafka StatefulSet
          echo "Checking Kafka StatefulSet..."
          kubectl get statefulset -n {{ .Values.global.namespace }} -l app.kubernetes.io/name=kafka || exit 1
          echo "Kafka StatefulSet exists ✓"
          {{- end }}

          echo ""
          echo "All ConfigMaps, Secrets, and Services exist!"
