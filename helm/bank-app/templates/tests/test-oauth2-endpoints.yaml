apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "bank-app.fullname" . }}-test-oauth2"
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "bank-app.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  containers:
    - name: curl-test
      image: curlimages/curl:latest
      command: ['sh', '-c']
      args:
        - |
          echo "Testing OAuth2 endpoints..."

          TOKEN_URL="http://{{ .Release.Name }}-auth-server:{{ index .Values "auth-server" "service" "port" }}/oauth2/token"
          WELL_KNOWN_URL="http://{{ .Release.Name }}-auth-server:{{ index .Values "auth-server" "service" "port" }}/.well-known/oauth-authorization-server"
          CLIENT_ID="{{ index .Values "accounts-service" "oauth2" "clientId" }}"
          CLIENT_SECRET="{{ index .Values "accounts-service" "oauth2" "clientSecret" }}"
          SCOPES="{{ index .Values "accounts-service" "oauth2" "scopes" | replace "," " " }}"

          # Wait for auth-server to be ready
          until curl -sf http://{{ .Release.Name }}-auth-server:{{ index .Values "auth-server" "service" "port" }}/actuator/health; do
            echo "Waiting for Auth Server..."
            sleep 5
          done

          # Test OAuth2 well-known configuration endpoint
          echo "Testing OAuth2 well-known configuration..."
          curl -sf "$WELL_KNOWN_URL" > /dev/null || {
            echo "WARNING: OAuth2 well-known endpoint not available (may be normal)"
          }

          # Test token endpoint with client credentials
          echo "Testing OAuth2 token endpoint with client credentials..."
          response=$(curl -s -X POST \
            -u "${CLIENT_ID}:${CLIENT_SECRET}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "scope=${SCOPES}" \
            "$TOKEN_URL" || true)


          if echo "$response" | grep -q "access_token"; then
            echo "OAuth2 token endpoint working correctly âœ“"
            echo "Successfully obtained access token"
          else
            echo "ERROR: Failed to obtain access token"
            echo "Response: $response"
            exit 1
          fi

          echo "OAuth2 tests passed!"
